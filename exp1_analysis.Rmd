---
title: "Asymmetric alignment paper, Experiment 1 analysis and graphs"
author: "Kenny Smith"
date: "04/2/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning=FALSE)

library(ggplot2)


data.directory = 'RawData/'

my.colours <- c("#EA7D00","#006DE9","#808080")

set.seed(67601)

```

# Read in data and report Ns

```{r}
exp1.data <- read.csv("ProcessedData/Experiment1Data.csv")

#put Block in desired order
exp1.data$Block <- factor(exp1.data$Block,
                               levels=c("Training",
                                        "Recall 1",
                                        "Interaction Block 1",
                                        "Interaction Block 2",
                                        "Recall 2"))

#Required to avoid overlapping text in some plots
exp1.data$BlockNewlines <- plyr::revalue(exp1.data$Block,
                                   c("Interaction Block 1"="Interaction\nBlock 1",
                                      "Interaction Block 2"="Interaction\nBlock 2"))


#I want Pair as a factor
#Note: pairs 60-102 collected at Edinburgh, 151-190 collected at Warwick
exp1.data$Pair <- as.factor(exp1.data$Pair)

plyr::ddply(exp1.data,~Condition,plyr::summarise,Current_N=length(unique(Pair)))

```





# Brief report of communicative success

This is very high throughout.

```{r}
exp1.by.pair.scores <- aggregate(Score~Condition+Block+Pair,data=subset(exp1.data,Block %in% c("Interaction Block 1", "Interaction Block 2")),FUN=sum)

aggregate(Score~Condition,data=exp1.by.pair.scores,FUN=mean)

aggregate(Score~Block+Condition,data=exp1.by.pair.scores,FUN=mean)
```


# Calculate and plot proportion of marked singulars by block

## Calculate proportions 

```{r}
#We only want to analyse singulars
exp1.data.singulars <- subset(exp1.data,Number==1)
exp1.data.by.block <- aggregate(data=exp1.data.singulars,
                                       Marked~Condition + Pair + Block + BlockNewlines + Participant + ParticipantID,
                                       FUN=mean)

exp1.data.by.block <- plyr::rename(exp1.data.by.block,c("Marked"="ProportionMarkedSingulars"))

exp1.data.by.block$Condition <- plyr::revalue(exp1.data.by.block$Condition,
                                                 c("66-33"="Condition: 66-33",
                                                   "83-17"="Condition: 83-17"))

```

## Proportion plots

One graph for all raw data, another with one facet per pair, one with mean and 95% CIs.

```{r fig.width=10}
#All data
ggplot(data=exp1.data.by.block, aes(x=BlockNewlines, y=ProportionMarkedSingulars, group=ParticipantID, colour=Pair,ymin=0,ymax=1)) +
  theme_bw() + 
  facet_wrap(~Condition, ncol=4) +
  geom_line() +
  ylab("Proportion Marked Singulars") + 
  theme(axis.title.x = element_blank()) +
  theme(legend.position="none") + 
  scale_y_continuous(breaks=seq(0,1,1/3),labels=c("0","1/3","2/3","1"))
```
```{r,include=FALSE}
#All data - plot for figure, output not included in markdown
ggplot(data=exp1.data.by.block, aes(x=BlockNewlines, y=ProportionMarkedSingulars, group=ParticipantID, colour=Pair,ymin=0,ymax=1)) +
  theme_bw() + 
  facet_wrap(~Condition, ncol=4) +
  geom_line() +
  ylab("Proportion Marked Singulars") + 
  theme(axis.title.x = element_blank()) +
  theme(legend.position="none") + 
  scale_y_continuous(breaks=seq(0,1,1/3),labels=c("0","1/3","2/3","1")) +
  ggsave(file="Plots/Exp1NumMarkingByParticipant.pdf",width=8, height=3)
```


```{r}
#For faccetted by-pair plot, need to add a DummyPair column so that the facets work out nicely - this is a little clumsy, but simplest way to do this seems to be to split by condition and convert Pair factor to integers
exp1.data.by.block.6633 <- subset(exp1.data.by.block,Condition=='Condition: 66-33')

exp1.data.by.block.6633$DummyPair <- droplevels(exp1.data.by.block.6633$Pair)

#change levels to integers
levels(exp1.data.by.block.6633$DummyPair) <- 1:length(levels(exp1.data.by.block.6633$DummyPair))

#ditto for other condition
exp1.data.by.block.8317 <- subset(exp1.data.by.block,Condition=='Condition: 83-17')

exp1.data.by.block.8317$DummyPair <- droplevels(exp1.data.by.block.8317$Pair)

#change levels to integers
levels(exp1.data.by.block.8317$DummyPair) <- 1:length(levels(exp1.data.by.block.8317$DummyPair))

#and recombine
exp1.data.by.block.dummyp <- rbind(exp1.data.by.block.6633,exp1.data.by.block.8317)
```

```{r fig.height=20, fig.width=12}
#By-pair figure
ggplot(data=exp1.data.by.block.dummyp, aes(x=BlockNewlines, y=ProportionMarkedSingulars, group=ParticipantID, colour=Pair,ymin=0,ymax=1)) +
  theme_bw() + 
  facet_grid(DummyPair ~ Condition) +
  geom_line() +
  ylab("Proportion Marked Singulars") + 
  theme(legend.position="none") + 
  scale_y_continuous(breaks=seq(0,1,1/3),labels=c("0","1/3","2/3","1")) +
  theme(strip.text.y = element_blank()) + 
  theme(axis.title.x = element_blank()) 
```

```{r include=FALSE}
#By-pair figure for paper
ggplot(data=exp1.data.by.block.dummyp, aes(x=BlockNewlines, y=ProportionMarkedSingulars, group=ParticipantID, colour=Pair,ymin=0,ymax=1)) +
  theme_bw() + 
  facet_grid(DummyPair ~ Condition) +
  geom_line() +
  ylab("Proportion Marked Singulars") + 
  theme(legend.position="none") + 
  scale_y_continuous(breaks=seq(0,1,1/3),labels=c("0","1/3","2/3","1")) +
  theme(strip.text.y = element_blank()) + 
  theme(axis.title.x = element_blank()) +
  ggsave(file="Plots/Exp1NumMarkingByPair.pdf",width=8, height=10)
```

```{r}
#Means and CIs
ggplot(data=exp1.data.by.block, aes(x=Participant, y=ProportionMarkedSingulars, group=Participant, shape=Participant,fill=Participant)) +
  theme_bw() + 
  facet_grid(Condition~Block) +
  stat_summary(geom='bar', fun.y='mean', position='dodge',colour='black') +
  stat_summary(geom='errorbar',fun.data='mean_cl_boot',fun.ymin="min", fun.ymax="max",colour="black",width=0.1) +
  stat_summary(geom='point', fun.y='mean', position='dodge',colour='black') +
  scale_fill_manual(values=c(my.colours[2],my.colours[1],my.colours[3])) +
  coord_cartesian(ylim=c(0,1)) +
  scale_y_continuous(breaks=seq(0,1,1/3),labels=c("0","1/3","2/3","1")) +
  ylab("Proportion Marked Singulars") + 
  theme(axis.title.x = element_blank()) +
  theme(legend.position="none") 
```

```{r include=FALSE}
#Means and CIs - for paper

ggplot(data=exp1.data.by.block, aes(x=Participant, y=ProportionMarkedSingulars, group=Participant, shape=Participant,fill=Participant)) +
  theme_bw() + 
  facet_grid(Condition~Block) +
  stat_summary(geom='bar', fun.y='mean', position='dodge',colour='black') +
  stat_summary(geom='errorbar',fun.data='mean_cl_boot',fun.ymin="min", fun.ymax="max",colour="black",width=0.1) +
  stat_summary(geom='point', fun.y='mean', position='dodge',colour='black') +
  scale_fill_manual(values=c(my.colours[2],my.colours[1],my.colours[3])) +
  coord_cartesian(ylim=c(0,1)) +
  scale_y_continuous(breaks=seq(0,1,1/3),labels=c("0","1/3","2/3","1")) +
  ylab("Proportion Marked Singulars") + 
  theme(axis.title.x = element_blank()) +
  theme(legend.position="none") + 
  ggsave(file="Plots/Exp1NumMarking.pdf",width=8, height=4)
```

## Count of systematic users and non-users at recall 1
```{r}
systematic.users <- subset(exp1.data.by.block,Block=="Interaction Block 2" & (ProportionMarkedSingulars==1 | ProportionMarkedSingulars==0))
plyr::ddply(systematic.users,~Condition,plyr::summarise,Current_N=length(unique(Pair)))
```

## Count of systematic users and non-users at end of interaction

```{r}
#In order to count convergence on systematic use/non-use, aggregating over participants in each pair
exp1.data.by.block.agg <- aggregate(ProportionMarkedSingulars~Condition+Pair+Block,data=exp1.data.by.block,FUN=mean)
systematic.user.pairs <- subset(exp1.data.by.block.agg,Block=="Interaction Block 2" & ProportionMarkedSingulars==1)
systematic.user.pairs$Pair
length(unique(systematic.user.pairs$Pair))

systematic.nonuser.pairs <- subset(exp1.data.by.block.agg,Block=="Interaction Block 2" & ProportionMarkedSingulars==0)
systematic.nonuser.pairs$Pair
length(unique(systematic.nonuser.pairs$Pair))
```

# Plot change from block to block, run statistics on those changes

## Plots showing changes in marker usage from block to block

```{r}
#The most convenient way to calculate differences from block to block is to restructure the data to wide format.
#BlockNewlines causes irritation here, so selecting it out
exp1.change.data <- tidyr::spread(data=dplyr::select(exp1.data.by.block,-BlockNewlines),Block,ProportionMarkedSingulars)

exp1.change.data$ChangeTrainingRecall1 <- exp1.change.data$'Recall 1' - exp1.change.data$'Training'

exp1.change.data$ChangeRecall1Interaction2 <- exp1.change.data$'Interaction Block 2'-exp1.change.data$'Recall 1'

exp1.change.data$ChangeRecall1Recall2 <- exp1.change.data$'Recall 2'-exp1.change.data$'Recall 1'


#convert back to long format for plotting
exp1.change.data.for.plotting <- dplyr::select(exp1.change.data,-Training,-'Recall 1',-'Recall 2',-'Interaction Block 1',-'Interaction Block 2')

exp1.change.data.for.plotting <- tidyr::gather(exp1.change.data.for.plotting,
BlockToBlock,Change,ChangeTrainingRecall1,ChangeRecall1Interaction2,ChangeRecall1Recall2)

#Make column names more user-friendly
exp1.change.data.for.plotting$BlockToBlock <- plyr::revalue(exp1.change.data.for.plotting$BlockToBlock,
                                                   c("ChangeTrainingRecall1"="Training to Recall 1",
                                                     "ChangeRecall1Interaction2"="Recall 1 to Interaction Block 2",
                                                     "ChangeRecall1Recall2"="Recall 1 to Recall 2"))

#what I am actually going to want to plot for the change data is either both conditions collapsed, but seperated by P1/P2,Both Ps.
#to do this, I am going to duplicate the data for the "Both Ps" column, stick them together, and remove the Condition column
exp1.change.data.for.plotting.Pscombined <- exp1.change.data.for.plotting
exp1.change.data.for.plotting.Pscombined$Participant <- "Both Ps"
exp1.change.data.for.plotting.combined <- rbind(exp1.change.data.for.plotting,exp1.change.data.for.plotting.Pscombined)
exp1.change.data.for.plotting.combined$Condition <- NULL
#want to reorder the levels so that the BothPs data is last
exp1.change.data.for.plotting.combined$Participant <- factor(exp1.change.data.for.plotting.combined$Participant,levels=c("P1","P2","Both Ps"))
```


Plot for Training to Recall 1. The statistics (below) show no difference by condition but a difference between participants - I am therefore plotting data collapsed across both conditions, but separated by participant.
```{r}
ggplot(data=subset(exp1.change.data.for.plotting.combined,BlockToBlock=="Training to Recall 1"), aes(x=Participant, y=Change, fill=Participant)) +
  theme_bw() + 
  geom_boxplot() +
  scale_fill_manual(values=c(my.colours[2],my.colours[1],my.colours[3])) +
  scale_y_continuous(limits = c(-1,1.1),breaks=seq(-1,1,1/3),labels=c("-1","-2/3","-1/3","0","+1/3","+2/3","+1")) +
  ylab("Change") + 
  theme(axis.title.x = element_blank()) +
  theme(legend.position="none") + 
  ggtitle("Training to Recall 1") 
```

```{r include=FALSE}
#for paper - includes annotations for statistical significance.
ggplot(data=subset(exp1.change.data.for.plotting.combined,BlockToBlock=="Training to Recall 1"), aes(x=Participant, y=Change, fill=Participant)) +
  theme_bw() + 
  geom_boxplot() +
  scale_fill_manual(values=c(my.colours[2],my.colours[1],my.colours[3])) +
  scale_y_continuous(limits = c(-1,1.1),breaks=seq(-1,1,1/3),labels=c("-1","-2/3","-1/3","0","+1/3","+2/3","+1")) +
  ylab("Change") + 
  theme(axis.title.x = element_blank()) +
  theme(legend.position="none") + 
  ggtitle("Training to Recall 1") +
  annotate("text",x=1.5,y=1.09,label="**") + #add ** to indicate p<.01 between participants
  geom_segment(aes(x=1, y=1.1, xend=1.4, yend=1.1)) + geom_segment(aes(x=1.6, y=1.1, xend=2, yend=1.1)) + #add lines either side of **
  annotate("text",x=1,y=3/6,label="p=.051") + #add note about n.s.difference from 0
  annotate("text",x=2,y=-2.4/6,label="*") + #add note about n.s.difference from 0
  annotate("text",x=3,y=-2.4/6,label="n.s.") + #add note about n.s.difference from 0
  ggsave(file="Plots/Exp1TrainingToRecall1Change.pdf",width=4, height=4)
```

Plot for Recall 1 to Interaction Block 2 - again, the statistics indicate no difference between conditions but a significant difference between participants, so we will plot collapsing across conditions.

```{r}
ggplot(data=subset(exp1.change.data.for.plotting.combined,BlockToBlock=="Recall 1 to Interaction Block 2"), aes(x=Participant, y=Change, fill=Participant)) +
  theme_bw() + 
  geom_boxplot() +
  scale_fill_manual(values=c(my.colours[2],my.colours[1],my.colours[3])) +
  scale_y_continuous(limits = c(-1,1.1),breaks=seq(-1,1,1/3),labels=c("-1","-2/3","-1/3","0","+1/3","+2/3","+1")) +
  ylab("Change") + 
  theme(axis.title.x = element_blank()) +
  theme(legend.position="none") + 
  ggtitle("Recall 1 To Interaction Block 2")
```

```{r include=FALSE}
#Plot for paper - strip out axis labels since these are provides elsewhere, add annotations
ggplot(data=subset(exp1.change.data.for.plotting.combined,BlockToBlock=="Recall 1 to Interaction Block 2"), aes(x=Participant, y=Change, fill=Participant)) +
  theme_bw() + 
  geom_boxplot() +
  scale_fill_manual(values=c(my.colours[2],my.colours[1],my.colours[3])) +
  scale_y_continuous(limits = c(-1,1.1),breaks=seq(-1,1,1/3),labels=c("-1","-2/3","-1/3","0","+1/3","+2/3","+1")) +
  ylab("Change") + 
  theme(axis.title.x = element_blank()) +
  theme(axis.title.y = element_blank()) +
  theme(axis.ticks = element_blank(), axis.text.y = element_blank()) + 
  theme(legend.position="none") + 
  ggtitle("Recall 1 To Interaction Block 2") +
  annotate("text",x=1.5,y=1.1,label="**") + #signficant difference between ps
  geom_segment(aes(x=1, y=1.1, xend=1.4, yend=1.1)) + geom_segment(aes(x=1.6, y=1.1, xend=2, yend=1.1)) + #add lines either side of text
  annotate("text",x=0.8,y=1/6,label="***") + #add note about difference from 0 for P1s
  annotate("text",x=1.8,y=1/6,label="n.s.") + #add note about difference from 0 for P2s
  annotate("text",x=2.8,y=1/6,label="**") + #add note about difference from 0 overall
  ggsave(file="Plots/Exp1Recall1ToInteraction2Change.pdf",width=4, height=4)
```

Plot for Recall 1 to Recall 2 - again, collapsing across conditions here.
```{r}
ggplot(data=subset(exp1.change.data.for.plotting.combined,BlockToBlock=="Recall 1 to Recall 2"), aes(x=Participant, y=Change, fill=Participant)) +
  theme_bw() + 
  geom_boxplot() +
  scale_fill_manual(values=c(my.colours[2],my.colours[1],my.colours[3])) +
  scale_y_continuous(limits = c(-1,1.1),breaks=seq(-1,1,1/3),labels=c("-1","-2/3","-1/3","0","+1/3","+2/3","+1")) +
  ylab("Change") + 
  theme(axis.title.x = element_blank()) +
  theme(legend.position="none") + 
  ggtitle("Recall 1 To Recall 2")

```

```{r include=FALSE}
#Plot for paper - missing y axis title, annotations
ggplot(data=subset(exp1.change.data.for.plotting.combined,BlockToBlock=="Recall 1 to Recall 2"), aes(x=Participant, y=Change, fill=Participant)) +
  theme_bw() + 
  geom_boxplot() +
  scale_fill_manual(values=c(my.colours[2],my.colours[1],my.colours[3])) +
  scale_y_continuous(limits = c(-1,1.1),breaks=seq(-1,1,1/3),labels=c("-1","-2/3","-1/3","0","+1/3","+2/3","+1")) +
  theme(axis.title.x = element_blank()) +
  theme(legend.position="none") + 
  theme(axis.title.y = element_blank()) +
  theme(axis.ticks = element_blank(), axis.text.y = element_blank()) + 
  ggtitle("Recall 1 To Recall 2") +
  annotate("text",x=1.5,y=1.1,label="p=.064") + #marginal difference between ps
  geom_segment(aes(x=1, y=1.1, xend=1.2, yend=1.1)) + geom_segment(aes(x=1.8, y=1.1, xend=2, yend=1.1)) + #add lines either side of text
  annotate("text",x=1,y=5/6,label="**") + #add note about difference from 0 for P1s
  annotate("text",x=2,y=5/6,label="n.s.") + #add note about difference from 0 for P2s
  annotate("text",x=3,y=5/6,label="**") + #add note about difference from 0 overall
  ggsave(file="Plots/Exp1Recall1ToRecall2Change.pdf",width=4, height=4)

```

## Stats for probability matching (change from Training to Recall 1)

Q1a: do the conditions differ in change from trainign to recall 1? **Answer is no**.

```{r}
wilcox.test(subset(exp1.change.data,Condition=="Condition: 66-33")$ChangeTrainingRecall1, 
            subset(exp1.change.data,Condition=="Condition: 83-17")$ChangeTrainingRecall1) 
```

Q1b: do the Ps differ in accuracy?. **Answer is yes**.

```{r}
wilcox.test(subset(exp1.change.data,Participant=="P1")$ChangeTrainingRecall1, 
            subset(exp1.change.data,Participant=="P2")$ChangeTrainingRecall1) 
```


Q2: Does the change from training differ from 0? Doing this for all data, since the initial test suggests no difference between conditions. **Answer is no**.
```{r}
wilcox.test(exp1.change.data$ChangeTrainingRecall1) 
```

Q2a: since the effect of P was significant, better test P1 and P2 seperately

Some evidence for a significant shift in both (marginal for P1s, clearer in P2s).

```{r}
wilcox.test(subset(exp1.change.data,Participant=="P1")$ChangeTrainingRecall1)
wilcox.test(subset(exp1.change.data,Participant=="P2")$ChangeTrainingRecall1)
```

## Stats for change in use due to interaction (change from Recall 1 to Interaction 2)

Q1a: do the conditions differ in change from recall 1 to interaction 2? **No**. 

```{r}
wilcox.test(subset(exp1.change.data,Condition=="Condition: 66-33")$ChangeRecall1Interaction2, 
            subset(exp1.change.data,Condition=="Condition: 83-17")$ChangeRecall1Interaction2) 
```

Q1b: do the Ps differ? **Yes**. 

```{r}
wilcox.test(subset(exp1.change.data,Participant=="P1")$ChangeRecall1Interaction2, 
            subset(exp1.change.data,Participant=="P2")$ChangeRecall1Interaction2) 
```

Q2a: Does the change from Recall 1 to Interaction 2 differ from 0? **Yes**.

```{r}
wilcox.test(exp1.change.data$ChangeRecall1Interaction2) 
```

Q2b: Since the effect of Participant was significant, test this seperately for P1 and P2.

P1 show an effect.

P2 do not.

This suggests that participant with the higher frequency of marker use in their training (the P1s) change more, and downwards, during interaction.

```{r}
wilcox.test(subset(exp1.change.data,Participant=="P1")$ChangeRecall1Interaction2)
wilcox.test(subset(exp1.change.data,Participant=="P2")$ChangeRecall1Interaction2) 
```

## Stats for change from pre-interaction Recall 1 to post-interaction Recall 2

This shows the lasting effect of interaction.

Q1a: do the conditions differ in change from Recall 1 to Recall 2? **No**.

```{r}
wilcox.test(subset(exp1.change.data,Condition=="Condition: 66-33")$ChangeRecall1Recall2, 
            subset(exp1.change.data,Condition=="Condition: 83-17")$ChangeRecall1Recall2) 
```

Q1b: do the Ps differ? **Marginally**. 

```{r}
wilcox.test(subset(exp1.change.data,Participant=="P1")$ChangeRecall1Recall2, 
            subset(exp1.change.data,Participant=="P2")$ChangeRecall1Recall2) 
```

Q2: does the change from Recall 1 to Recall 2 differ from 0? **Yes**. 
```{r}
wilcox.test(exp1.change.data$ChangeRecall1Recall2) 
```

Q2a: since the participants differed in amount of change, test them separately. 

P1s show an effect. 

P2s do not. 

This is consistent with a small downwards adjustment in P1s that outlasts interaction. 

```{r}
wilcox.test(subset(exp1.change.data,Participant=='P1')$ChangeRecall1Recall2) 
wilcox.test(subset(exp1.change.data,Participant=='P2')$ChangeRecall1Recall2) 

```

# Plot within-pair differences and do statistics over these

We can measure alignment using within-pair difference in marker usage - lower within-pair difference is indicative of higher alignment.

## Plots showing within-pair differences

```{r}
# The easiest way to do this is to build a wide-format table by subsetting based on P then merging

p1 <- dplyr::select(subset(exp1.data.by.block,Participant=="P1"),-Participant,-ParticipantID)
p2 <- dplyr::select(subset(exp1.data.by.block,Participant=="P2"),-Participant,-ParticipantID)
exp1.diffs <- merge(p1,p2,by=c('Condition','Pair','Block','BlockNewlines'))

#calculate absolute diffs
exp1.diffs$Difference <- abs(exp1.diffs$ProportionMarkedSingulars.x-exp1.diffs$ProportionMarkedSingulars.y)

#remove unnecessary columns, reorder Block again
exp1.diffs <- dplyr::select(exp1.diffs,-ProportionMarkedSingulars.x,-ProportionMarkedSingulars.y)
```


```{r}
ggplot(data=exp1.diffs, aes(x=BlockNewlines, y=Difference, fill=Condition,ymin=0,ymax=1)) +
  theme_bw() + 
  geom_boxplot() +
  facet_grid(Condition~.) +
  scale_fill_manual(values=c(my.colours[2],my.colours[1],my.colours[3])) +
  scale_y_continuous(breaks=seq(0,1,1/3),labels=c("0","1/3","2/3","1")) +
  ylab("Within-Pair Difference") + 
  theme(axis.title.x = element_blank()) +
  theme(legend.position="none") 
```

```{r include=FALSE}
#Plot for paper
ggplot(data=exp1.diffs, aes(x=BlockNewlines, y=Difference, fill=Condition,ymin=0,ymax=1)) +
  theme_bw() + 
  geom_boxplot() +
  facet_grid(Condition~.) +
  scale_fill_manual(values=c(my.colours[2],my.colours[1],my.colours[3])) +
  scale_y_continuous(breaks=seq(0,1,1/3),labels=c("0","1/3","2/3","1")) +
  ylab("Within-Pair Difference") + 
  theme(axis.title.x = element_blank()) +
  theme(legend.position="none") +  
  ggsave(file="Plots/Exp1DiffPlot.pdf",width=5, height=3)
```


## Plots showing change in within-pair differences

Also useful to show the change in within-pair differences over time.

```{r}
#The most convenient way to calculate differences from block to block is to restructure the data to wide format.
exp1.diffs.change.data <- tidyr::spread(data=dplyr::select(exp1.diffs,-BlockNewlines),Block,Difference)

exp1.diffs.change.data$ChangeTrainingRecall1 <- exp1.diffs.change.data$'Recall 1' - exp1.diffs.change.data$'Training'

exp1.diffs.change.data$ChangeRecall1Interaction2 <- exp1.diffs.change.data$'Interaction Block 2'-exp1.diffs.change.data$'Recall 1'

exp1.diffs.change.data$ChangeRecall1Recall2 <- exp1.diffs.change.data$'Recall 2'-exp1.diffs.change.data$'Recall 1'


#convert back to long format for plotting
exp1.diffs.change.data.for.plotting <- dplyr::select(exp1.diffs.change.data,-Training,-'Recall 1',-'Recall 2',-'Interaction Block 1',-'Interaction Block 2')

exp1.diffs.change.data.for.plotting <- tidyr::gather(exp1.diffs.change.data.for.plotting,
BlockToBlock,DifferenceChange,ChangeTrainingRecall1,ChangeRecall1Interaction2,ChangeRecall1Recall2)

#Make column names more user-friendly
exp1.diffs.change.data.for.plotting$BlockToBlock <- plyr::revalue(exp1.diffs.change.data.for.plotting$BlockToBlock,
                                                   c("ChangeTrainingRecall1"="Training to Recall 1",
                                                     "ChangeRecall1Interaction2"="Recall 1 to Interaction Block 2",
                                                     "ChangeRecall1Recall2"="Recall 1 to Recall 2"))

#Now duplicate data and add in "All Experiment 1 data", with all the data from both conditions, not seperated by Participant
exp1.diffs.change.data.for.plotting.combined <- exp1.diffs.change.data.for.plotting
exp1.diffs.change.data.for.plotting.combined$Condition <- "Both\nconditions"
```

```{r}

#For Recall 1 to Interaction 2 I want to plot the conditions seperately and combined
ggplot(data=subset(rbind(exp1.diffs.change.data.for.plotting,
                                                     exp1.diffs.change.data.for.plotting.combined),BlockToBlock=="Recall 1 to Interaction Block 2"), aes(x=Condition, y=DifferenceChange, fill=Condition)) +
  theme_bw() + 
  geom_boxplot() +
  expand_limits(y=1) +
  scale_fill_manual(values=c(my.colours[2],my.colours[1],my.colours[3])) +
  scale_y_continuous(breaks=seq(-1,1,1/3),labels=c("-1","-2/3","-1/3","0","+1/3","+2/3","+1")) +
  ylab("Change In Within-Pair Difference") + 
  theme(axis.title.x = element_blank()) +
  theme(legend.position="none") + 
  ggtitle("Recall 1 to Interaction Block 2") 
```

```{r include=FALSE}
#Plot for paper
ggplot(data=subset(rbind(exp1.diffs.change.data.for.plotting,
                                                     exp1.diffs.change.data.for.plotting.combined),BlockToBlock=="Recall 1 to Interaction Block 2"), aes(x=Condition, y=DifferenceChange, fill=Condition)) +
  theme_bw() + 
  geom_boxplot() +
  expand_limits(y=1) +
  scale_fill_manual(values=c(my.colours[2],my.colours[1],my.colours[3])) +
  scale_y_continuous(breaks=seq(-1,1,1/3),labels=c("-1","-2/3","-1/3","0","+1/3","+2/3","+1")) +
  ylab("Change In Within-Pair Difference") + 
  theme(axis.title.x = element_blank()) +
  theme(legend.position="none") + 
  ggtitle("Recall 1 to Interaction Block 2") +
  annotate("text",x=1.5,y=5/6,label="p=.079") + #marginal difference between conditions
  geom_segment(aes(x=1, y=5/6, xend=1.2, yend=5/6)) + geom_segment(aes(x=1.8, y=5/6, xend=2, yend=5/6)) + #add lines either side of text
  annotate("text",x=1,y=1/3,label="***") + #add note about difference from 0 for P1s
  annotate("text",x=2,y=1/3,label="***") + #add note about difference from 0 for P2s
  annotate("text",x=3,y=1/3,label="***") + #add note about difference from 0 overall
  ggsave(file="Plots/Exp1DiffChangeRecall1Interaction2.pdf",width=5, height=3)
```

```{r}
#For Recall 1 to Recall 2 I want to plot both conditions combined only

ggplot(data=subset(exp1.diffs.change.data.for.plotting.combined,BlockToBlock=="Recall 1 to Recall 2"), aes(x=Condition, y=DifferenceChange, fill=Condition)) +
  theme_bw() + 
  geom_boxplot() +
  expand_limits(y=1) +
  scale_fill_manual(values=c(my.colours[2],my.colours[1],my.colours[3])) +
  scale_y_continuous(breaks=seq(-1,1,1/3),labels=c("-1","-2/3","-1/3","0","+1/3","+2/3","+1")) +
  ylab("Change In Within-Pair Difference") + 
  theme(axis.title.x = element_blank()) +
  #theme(strip.text.y = element_blank()) + 
  theme(legend.position="none",plot.title = element_text(size=12,hjust=0.5)) + 
  ggtitle("Recall 1 to Recall 2")
```

```{r, include=FALSE}
#Plot for paper -0 no y axis text, annotations

ggplot(data=subset(exp1.diffs.change.data.for.plotting.combined,BlockToBlock=="Recall 1 to Recall 2"), aes(x=Condition, y=DifferenceChange, fill=Condition)) +
  theme_bw() + 
  geom_boxplot() +
  expand_limits(y=1) +
  scale_fill_manual(values=c(my.colours[2],my.colours[1],my.colours[3])) +
  scale_y_continuous(breaks=seq(-1,1,1/3),labels=c("-1","-2/3","-1/3","0","+1/3","+2/3","+1")) +
  ylab("Change In Within-Pair Difference") + 
  theme(axis.title.x = element_blank()) +
  #theme(strip.text.y = element_blank()) + 
  theme(legend.position="none",plot.title = element_text(size=12,hjust=0.5)) + 
  theme(axis.title.y = element_blank()) +
  theme(axis.ticks = element_blank(), axis.text.y = element_blank()) + 
  ggtitle("Recall 1 to Recall 2") +
  annotate("text",x=1,y=5.5/6,label="**") + #add note about difference from 0 for P1s
  ggsave(file="Plots/Exp1DiffChangeRecall1Recall2.pdf",width=5*(.24/.74), height=3)
```

## Stats for change in within-pair difference due to interaction (change from Recall 1 to interaction 2)

Q1: do the conditions differ in change from recall 1 to interaction 2? **Marginally**. 
```{r}
wilcox.test(subset(exp1.diffs.change.data,Condition=="Condition: 66-33")$ChangeRecall1Interaction2, 
            subset(exp1.diffs.change.data,Condition=="Condition: 83-17")$ChangeRecall1Interaction2) 
```

Q2a: do the change from recall 1 to interaction 2 differ from 0? **Yes**. 

```{r}
wilcox.test(exp1.diffs.change.data$ChangeRecall1Interaction2) 
```

Q2b: do the same seperately, by condition. 

66-33 show the effect. 

83-17 show the effect.

```{r}
wilcox.test(subset(exp1.diffs.change.data,Condition=="Condition: 66-33")$ChangeRecall1Interaction2)
wilcox.test(subset(exp1.diffs.change.data,Condition=="Condition: 83-17")$ChangeRecall1Interaction2) 
```

## Stats for change in within-pair difference from Recall 1 to Recall 2

This is another way of measuring lasting alignment.

Q1: do the conditions differ in change from recall 1 to recall 2? **No**.

```{r}
wilcox.test(subset(exp1.diffs.change.data,Condition=="Condition: 66-33")$ChangeRecall1Recall2, 
            subset(exp1.diffs.change.data,Condition=="Condition: 83-17")$ChangeRecall1Recall2) 
```

Q2: does the change from recall 1 to recall 2 differ from 0? **Yes**. 

```{r}
wilcox.test(exp1.diffs.change.data$ChangeRecall1Recall2) 
```

#Additional analysis requested by a reviewer

One reviewer wanted to know if the reductions in within-pair difference we see here reflect alignment, or just the fact that everyone heads for zero marking and aligns coincidentally. We can test this in our data by seeing whether the observed changes in within-pair difference are greater than those we obtain if we randomly re-paired participants and re-calculated within-pair difference for these pseudo-pairs. 

To do this we will calculate the mean within-pair difference at Interaction 2 for the veridical pairs, then calculate 1000 pseudo-pairings and evaluate how often these exhibit equal or lower mean within-pair difference. The random pseudo-pairings have to reflect the conditions and P1-P2 distinctions so as to avoid e.g. pairing a 66% participant with an 83% participant.

```{r}
veridical.mean.wpd <- mean(subset(exp1.diffs,Block=="Interaction Block 2")$Difference)

#make a copy of the data to work with - we only need interaction block 2 data
exp1.data.by.block.pseudo <- dplyr::select(subset(exp1.data.by.block,Block=="Interaction Block 2"),-Block,-BlockNewlines)

#helper function to re-assign participants to pseudo-pairs - slightly laoborious
#in order to avoid mixing across conditions etc
reassign.pairs <- function(in.data) {
  #subset data by block and participant
  p1.6633 <- dplyr::select(subset(in.data,Participant=="P1" & Condition=="Condition: 66-33"),-Participant,-ParticipantID)
  p2.6633 <- dplyr::select(subset(in.data,Participant=="P2" & Condition=="Condition: 66-33"),-Participant,-ParticipantID)
  p1.8317 <- dplyr::select(subset(in.data,Participant=="P1" & Condition=="Condition: 83-17"),-Participant,-ParticipantID)
  p2.8317 <- dplyr::select(subset(in.data,Participant=="P2" & Condition=="Condition: 83-17"),-Participant,-ParticipantID)

  #randomise pair assignments
  p1.6633$Pair <- sample(p1.6633$Pair)
  p2.6633$Pair <- sample(p2.6633$Pair)
  p1.8317$Pair <- sample(p1.8317$Pair)
  p2.8317$Pair <- sample(p2.8317$Pair)

  diffs.pseudo.6633 <- merge(p1.6633,p2.6633,by=c('Condition','Pair'))
  diffs.pseudo.8317 <- merge(p1.8317,p2.8317,by=c('Condition','Pair'))
  diffs.pseudo <- rbind(diffs.pseudo.6633,diffs.pseudo.8317)
  
  #calculate absolute diffs
  diffs.pseudo$Difference <-
    abs(diffs.pseudo$ProportionMarkedSingulars.x-diffs.pseudo$ProportionMarkedSingulars.y)

  #remove unnecessary columns, reorder Block again
  diffs.pseudo <- dplyr::select(diffs.pseudo,-ProportionMarkedSingulars.x,-ProportionMarkedSingulars.y)
  
  #calculate and return mean
  mean(diffs.pseudo$Difference)
}

sampled.diffs <- replicate(1000,reassign.pairs(exp1.data.by.block.pseudo))

#report the veridfical within-pair difference
veridical.mean.wpd

#report the mean of the sampled diffs
mean(sampled.diffs)

#this is the number of cases where we see the same or smaller within-pair difference
sum(sampled.diffs <= veridical.mean.wpd)

#this is the proportion of cases where we see the same or smaller within-pair difference
sum(sampled.diffs <= veridical.mean.wpd)/length(sampled.diffs)
```
